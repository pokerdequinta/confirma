<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lista de Confirma√ß√µes Poker de Quinta - 1¬™ Etapa</title>

<style>
@import url('https://fonts.googleapis.com/css2?family=Anton&family=Roboto:wght@300;400;700&display=swap');

*{margin:0;padding:0;box-sizing:border-box}

body {
    font-family: 'Roboto', sans-serif; /* Fonte alterada para Roboto */
    background: #0d1b0d;
    color: #fff;
    min-height: 100vh;
}

.logo-top{text-align:center;padding:20px}
.container{max-width:1000px;margin:auto;padding:20px}

header {
    text-align: center;
    background: #102810;
    border: 2px solid #d4a121;
    border-radius: 15px;
    padding: 30px;
    margin-bottom: 30px;
}

h1 { font-family: 'Anton', sans-serif; color: #d4a121; letter-spacing: 3px; }
.subtitle { margin-top: 10px; font-weight: 300; }

.info-cards { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 25px; }
.info-card { background: #102810; border: 2px solid #d4a121; border-radius: 12px; padding: 20px; text-align: center; }
.info-card h2 { font-family: 'Anton'; font-size: 2.5em; color: #d4a121; }

.add-btn { width: 100%; padding: 15px; background: #d4a121; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; margin-bottom: 10px; color: #000; font-family: 'Roboto'; }
.cancel-btn-main { width: 100%; padding: 15px; background: #c72c48; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; margin-bottom: 20px; color: #fff; font-family: 'Roboto'; }

.section { background: #102810; border: 2px solid #d4a121; border-radius: 12px; padding: 20px; margin-bottom: 25px; }
.player-list { list-style: none; }
.player-item { display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,.05); padding: 15px; border-radius: 10px; margin-bottom: 10px; gap: 10px; }
.player-info { display: flex; gap: 15px; align-items: center; flex-grow: 1; }
.player-number { font-family: 'Anton'; color: #d4a121; min-width: 30px; }
.player-details { display: flex; flex-direction: column; }
.player-details strong { font-size: 1.1em; }
.player-details small { color: #d4a121; font-size: 0.85em; margin-top: 2px; }

.player-badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75em; font-weight: 700; white-space: nowrap; }
.wait { background: #c72c48; color: #fff; }
.guest { background: #4CAF50; color: #000; }
.member { background: #1E90FF; color: #fff; }

.remove-btn { background: #c72c48; color: #fff; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-weight: bold; }
.empty-state { text-align: center; opacity: .7; padding: 30px; }

/* Modais */
.modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,.8); justify-content: center; align-items: center; z-index: 1000; }
.modal.active { display: flex; }
.modal-content { background: #102810; border: 2px solid #d4a121; border-radius: 15px; padding: 30px; width: 90%; max-width: 500px; }
.form-group { margin-bottom: 15px; }
.form-group label { color: #d4a121; font-weight: bold; display: block; margin-bottom: 5px; }
.form-group input, .form-group select { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #2d5016; background: #1a3d1a; color: #fff; font-family: 'Roboto'; }
.modal-buttons { display: flex; gap: 10px; margin-top: 20px; }
.modal-btn { flex: 1; padding: 12px; font-weight: bold; border: none; border-radius: 8px; cursor: pointer; font-family: 'Roboto'; }
.modal-btn.confirm { background: #d4a121; color: #000; }
.modal-btn.cancel { background: #c72c48; color: #fff; }

.status-indicator { position: fixed; top: 10px; right: 10px; background: #2d5016; padding: 8px 15px; border-radius: 20px; font-size: 0.85em; border: 1px solid #d4a121; }
</style>
</head>
<body>

<div class="status-indicator" id="statusIndicator">üîÑ Sincronizando...</div>

<div class="container">
    <header>
        <h1>POKER DE QUINTA</h1>
        <div class="subtitle">üìÖ 1¬™ Etapa - 29/01/2026</div>
    </header>

    <div class="info-cards">
        <div class="info-card"><h2 id="confirmedCount">0</h2>Confirmados</div>
        <div class="info-card"><h2 id="vacancyCount">20</h2>Vagas</div>
        <div class="info-card"><h2 id="waitlistCount">0</h2>Espera</div>
    </div>

    <button class="add-btn" id="btnConfirmar">‚ûï CONFIRMAR PRESEN√áA</button>
    <button class="cancel-btn-main" id="btnAbrirCancelar">‚ùå CANCELAR MINHA INSCRI√á√ÉO</button>

    <div class="section">
        <h3>‚úÖ CONFIRMADOS (LIMITE 20)</h3>
        <ul id="confirmedList" class="player-list"></ul>
    </div>

    <div class="section">
        <h3>‚è≥ LISTA DE ESPERA</h3>
        <ul id="waitlistList" class="player-list"></ul>
    </div>
</div>

<div class="modal" id="modal">
    <div class="modal-content">
        <h2>Confirmar Presen√ßa</h2>
        <div class="form-group">
            <label>Selecione seu Nome</label>
            <select id="playerNameSelect"></select>
        </div>
        <div class="form-group">
            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="isGuestCheck" style="width: 20px; height: 20px;"> Sou um Convidado
            </label>
        </div>
        <div id="guestFields" style="display:none">
            <div class="form-group">
                <label>Nome do Convidado</label>
                <input type="text" id="guestNameInput" placeholder="Digite o nome completo">
            </div>
        </div>
        <div class="modal-buttons">
            <button class="modal-btn cancel" id="btnFecharInscricao">Sair</button>
            <button class="modal-btn confirm" id="btnSalvarInscricao">Confirmar</button>
        </div>
    </div>
</div>

<div class="modal" id="modalCancelar">
    <div class="modal-content">
        <h2 style="color: #c72c48;">Cancelar Inscri√ß√£o</h2>
        <p style="margin: 10px 0; font-size: 0.9em; color: #ccc;">O sistema abrir√° seu WhatsApp para notificar o organizador.</p>
        <div class="form-group">
            <label>Qual nome deseja retirar?</label>
            <select id="cancelNameSelect"></select>
        </div>
        <div class="modal-buttons">
            <button class="modal-btn cancel" id="btnFecharCancel">Voltar</button>
            <button class="modal-btn confirm" id="btnExecutarCancelamento" style="background:#c72c48; color:#fff">Confirmar e Notificar</button>
        </div>
    </div>
</div>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
import { getDatabase, ref, push, onValue, remove } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

const firebaseConfig = {
    apiKey: "AIzaSyD_XXjcjJYM73wLTTzpDgzKCOZnztcJhjE",
    authDomain: "poker-de-quinta.firebaseapp.com",
    databaseURL: "https://poker-de-quinta-default-rtdb.firebaseio.com",
    projectId: "poker-de-quinta",
    storageBucket: "poker-de-quinta.firebasestorage.app",
    messagingSenderId: "776724152456",
    appId: "1:776724152456:web:fbffde9a1c1a7628c61f3d"
};

const LIMITE = 20;
const membrosOficiais = ["Amarildo","Boy","Buiu","Caio","Charles","Cleversson","Davi","Gera","Diego","Dos Anjos","Eduardo","Fernando","Gregory","Gaspar","Guilherme","Guti","Igor","Izidio","Jean","Jean Rebuy","Junior","Leo","Loreto","Lucas","Matheus","Maykon","Neto","Nil","Peterson","Rafael","Ricardo Amarante","Ricardo Linhares","Ricardo Matoso","Robson","Sergio","Solano","Tigre","Van Van","Waltinho","Wesley"];

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let confirmados = [];
let espera = [];

// Popular Listas
const pSelect = document.getElementById('playerNameSelect');
const cSelect = document.getElementById('cancelNameSelect');
membrosOficiais.sort().forEach(m => {
    pSelect.add(new Option(m, m));
    cSelect.add(new Option(m, m));
});

// Sync Firebase
onValue(ref(db, 'confirmados'), (snapshot) => {
    confirmados = [];
    snapshot.forEach(child => { confirmados.push({...child.val(), id: child.key}); });
    atualizarTudo();
});

onValue(ref(db, 'listaEspera'), (snapshot) => {
    espera = [];
    snapshot.forEach(child => { espera.push({...child.val(), id: child.key}); });
    atualizarTudo();
});

// Modais
btnConfirmar.onclick = () => document.getElementById('modal').classList.add('active');
btnFecharInscricao.onclick = () => document.getElementById('modal').classList.remove('active');
btnAbrirCancelar.onclick = () => document.getElementById('modalCancelar').classList.add('active');
btnFecharCancel.onclick = () => document.getElementById('modalCancelar').classList.remove('active');
isGuestCheck.onchange = e => document.getElementById('guestFields').style.display = e.target.checked ? 'block' : 'none';

// Salvar
btnSalvarInscricao.onclick = async () => {
    const isGuest = isGuestCheck.checked;
    const nome = isGuest ? document.getElementById('guestNameInput').value.trim() : pSelect.value;
    
    if(!nome) return alert("Informe o nome.");
    if([...confirmados, ...espera].some(p => p.nome.toLowerCase() === nome.toLowerCase())) return alert("J√° est√° na lista!");

    const payload = {
        nome: nome,
        isGuest: isGuest,
        membroResponsavel: isGuest ? pSelect.value : null,
        dataHora: new Date().toISOString()
    };

    try {
        const destino = (!isGuest && confirmados.length < LIMITE) ? 'confirmados' : 'listaEspera';
        await push(ref(db, destino), payload);
        document.getElementById('modal').classList.remove('active');
        document.getElementById('guestNameInput').value = "";
        isGuestCheck.checked = false;
        document.getElementById('guestFields').style.display = 'none';
    } catch (e) { alert("Erro ao salvar."); }
};

// Cancelamento
btnExecutarCancelamento.onclick = async () => {
    const nomeAlvo = cSelect.value;
    const player = confirmados.find(p => p.nome === nomeAlvo) || espera.find(p => p.nome === nomeAlvo);

    if(!player) return alert("Jogador n√£o encontrado.");

    if(confirm(`Confirmar cancelamento de ${nomeAlvo}?`)) {
        const isNaEspera = espera.some(p => p.id === player.id);
        await executarRemocao(player.id, isNaEspera);

        const celularDono = "5541987210685";
        const texto = encodeURIComponent(`‚ö†Ô∏è CANCELAMENTO: O jogador ${nomeAlvo} retirou o nome da lista.`);
        window.open(`https://wa.me/${celularDono}?text=${texto}`, '_blank');
        
        document.getElementById('modalCancelar').classList.remove('active');
    }
};

// L√≥gica de Remo√ß√£o R√≠gida (Apenas Membros Oficiais sobem da espera)
async function executarRemocao(id, isWait) {
    const playerSaindo = (isWait ? espera : confirmados).find(p => p.id === id);
    const path = isWait ? 'listaEspera' : 'confirmados';
    
    await remove(ref(db, `${path}/${id}`));

    // Se liberou vaga nos confirmados
    if(!isWait && espera.length > 0) {
        // BUSCA APENAS MEMBROS OFICIAIS NA ESPERA
        const membrosNaEspera = espera
            .filter(p => membrosOficiais.includes(p.nome) && !p.isGuest)
            .sort((a,b) => new Date(a.dataHora) - new Date(b.dataHora));

        if (membrosNaEspera.length > 0) {
            const proximoMembro = membrosNaEspera[0];
            await remove(ref(db, `listaEspera/${proximoMembro.id}`));
            await push(ref(db, 'confirmados'), { ...proximoMembro, id: null });
        }
        // Se houver apenas convidados, a vaga fica aberta.
    }
}

window.apagarManual = (id, isWait) => {
    if(confirm("Remover este convidado?")) executarRemocao(id, isWait);
};

function atualizarTudo() {
    document.getElementById('statusIndicator').textContent = '‚úÖ Sincronizado';
    document.getElementById('confirmedCount').textContent = confirmados.length;
    document.getElementById('vacancyCount').textContent = Math.max(0, LIMITE - confirmados.length);
    document.getElementById('waitlistCount').textContent = espera.length;

    const renderPlayer = (p, i, isWait) => {
        const dt = new Date(p.dataHora);
        const df = dt.toLocaleDateString('pt-BR', {day:'2-digit', month:'2-digit'});
        const hf = dt.toLocaleTimeString('pt-BR', {hour:'2-digit', minute:'2-digit'});
        
        const isMembro = membrosOficiais.includes(p.nome) && !p.isGuest;
        const badgeClass = p.isGuest ? 'guest' : (isMembro ? 'member' : 'wait');
        const badgeText = p.isGuest ? 'CONVIDADO' : 'MEMBRO';
        
        const btnRemover = !isMembro ? `<button class="remove-btn" onclick="apagarManual('${p.id}', ${isWait})">‚ùå</button>` : '';

        return `
            <li class="player-item">
                <div class="player-info">
                    <div class="player-number">${i+1}¬∫</div>
                    <div class="player-details">
                        <strong>${p.nome}</strong>
                        <small>üìÖ ${df} √†s ${hf} ${p.membroResponsavel ? '‚Ä¢ Ref: '+p.membroResponsavel : ''}</small>
                    </div>
                    <span class="player-badge ${badgeClass}">${badgeText}</span>
                </div>
                ${btnRemover}
            </li>`;
    };

    document.getElementById('confirmedList').innerHTML = confirmados
        .sort((a,b) => new Date(a.dataHora) - new Date(b.dataHora))
        .map((p, i) => renderPlayer(p, i, false)).join('') || '<li class="empty-state">Nenhum confirmado</li>';

    const esperaOrdenada = [...espera].sort((a,b) => {
        const am = membrosOficiais.includes(a.nome) && !a.isGuest;
        const bm = membrosOficiais.includes(b.nome) && !b.isGuest;
        return (bm - am) || (new Date(a.dataHora) - new Date(b.dataHora));
    });

    document.getElementById('waitlistList').innerHTML = esperaOrdenada
        .map((p, i) => renderPlayer(p, i, true)).join('') || '<li class="empty-state">Fila vazia</li>';
        
    verificarRegraQuarta();
}

function verificarRegraQuarta() {
    const agora = new Date();
    // Hoje √© quarta (3)? Passou das 10h? Tem vaga?
    if (agora.getDay() === 3 && agora.getHours() >= 10 && confirmados.length < LIMITE) {
        const proxM = espera.find(p => membrosOficiais.includes(p.nome) && !p.isGuest);
        if (proxM) executarRemocao(proxM.id, true);
    }
}
</script>
</body>
</html>
