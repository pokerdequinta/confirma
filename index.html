<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Confirma√ß√£o de Presen√ßa - 1¬™ Etapa</title>

<style>
@import url('https://fonts.googleapis.com/css2?family=Anton&display=swap');
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Segoe UI',Tahoma;background:#0d1b0d;color:#fff;min-height:100vh}
.logo-top{text-align:center;padding:20px}
.logo-top img{max-width:200px}
.container{max-width:1000px;margin:auto;padding:20px}
header{text-align:center;background:#102810;border:2px solid #d4a121;border-radius:15px;padding:30px;margin-bottom:30px}
h1{font-family:'Anton';color:#d4a121;letter-spacing:3px}
.subtitle{margin-top:10px}
.config-banner{background:#1a3d1a;border:2px solid #d4a121;border-radius:10px;padding:15px;margin-bottom:20px;text-align:center}
.config-banner.error{background:#3d1a1a;border-color:#c72c48}
.config-status{font-size:0.9em;margin-top:5px;opacity:0.9}
.info-cards{display:grid;grid-template-columns:repeat(3,1fr);gap:15px;margin-bottom:25px}
.info-card{background:#102810;border:2px solid #d4a121;border-radius:12px;padding:20px;text-align:center}
.info-card h2{font-family:'Anton';font-size:2.5em;color:#d4a121}
.add-btn{width:100%;padding:15px;background:#d4a121;border:none;border-radius:10px;font-weight:bold;cursor:pointer;margin-bottom:20px}
.add-btn:disabled{opacity:0.5;cursor:not-allowed}
.export-btn{background:#2d5016;margin-top:10px}
.section{background:#102810;border:2px solid #d4a121;border-radius:12px;padding:20px;margin-bottom:25px}
.player-list{list-style:none}
.player-item{display:flex;justify-content:space-between;align-items:center;background:rgba(255,255,255,.05);padding:15px;border-radius:10px;margin-bottom:10px;gap:10px}
.player-info{display:flex;gap:15px;align-items:center}
.player-number{font-family:'Anton';color:#d4a121}
.player-details{display:flex;flex-direction:column}
.player-details small{opacity:.85}
.player-badge{background:#d4a121;color:#000;padding:4px 10px;border-radius:20px;font-size:.8em;font-weight:bold}
.wait{background:#c72c48;color:#fff}
.guest{background:#4CAF50;color:#000}
.member{background:#1E90FF;color:#fff}
.remove-btn{background:#c72c48;color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer}
.empty-state{text-align:center;opacity:.7;padding:30px}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.8);justify-content:center;align-items:center;z-index:1000}
.modal.active{display:flex}
.modal-content{background:#102810;border:2px solid #d4a121;border-radius:15px;padding:30px;width:90%;max-width:500px}
.form-group{margin-bottom:15px}
.form-group label{color:#d4a121;font-weight:bold;display:block;margin-bottom:5px}
.form-group input,.form-group select,.form-group textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #2d5016;background:#1a3d1a;color:#fff}
.form-group textarea{min-height:100px;font-family:monospace;font-size:0.85em}
.modal-buttons{display:flex;gap:10px;margin-top:20px}
.modal-btn{flex:1;padding:10px;font-weight:bold;border:none;border-radius:8px;cursor:pointer}
.modal-btn.confirm{background:#d4a121;color:#000}
.modal-btn.cancel{background:#c72c48;color:#fff}
.loading{text-align:center;padding:20px;opacity:0.7}
</style>
</head>

<body>

<div class="logo-top">
<img src="logo pdq.png" onerror="this.style.display='none'">
</div>

<div class="container">

<header>
<h1>POKER DE QUINTA</h1>
<div class="subtitle">üìÖ 1¬™ Etapa - 29/01/2026</div>
</header>

<div class="config-banner" id="configBanner">
<div id="configMessage">‚öôÔ∏è Configure o Firebase para come√ßar</div>
<div class="config-status" id="configStatus"></div>
<button class="add-btn" onclick="openConfigModal()" style="margin-top:10px;max-width:300px;margin-left:auto;margin-right:auto">üîß Configurar Firebase</button>
</div>

<div id="appContent" style="display:none">

<div class="info-cards">
<div class="info-card"><h2 id="confirmedCount">0</h2>Confirmados</div>
<div class="info-card"><h2 id="vacancyCount">20</h2>Vagas</div>
<div class="info-card"><h2 id="waitlistCount">0</h2>Espera</div>
</div>

<button class="add-btn" id="btnConfirmar">‚ûï CONFIRMAR PRESEN√áA</button>
<button class="add-btn export-btn" id="btnExportar">üìä EXPORTAR CSV</button>

<div class="section">
<h3>‚úÖ CONFIRMADOS</h3>
<ul id="confirmedList" class="player-list">
<li class="loading">Carregando dados...</li>
</ul>
</div>

<div class="section">
<h3>‚è≥ LISTA DE ESPERA</h3>
<ul id="waitlistList" class="player-list">
<li class="loading">Carregando dados...</li>
</ul>
</div>

</div>

</div>

<!-- Modal Configura√ß√£o Firebase -->
<div class="modal" id="configModal">
<div class="modal-content">
<h2>‚öôÔ∏è Configura√ß√£o Firebase</h2>
<p style="margin-bottom:15px;opacity:0.8">Cole aqui as configura√ß√µes do seu projeto Firebase:</p>

<div class="form-group">
<label>Firebase Config (JSON)</label>
<textarea id="firebaseConfigInput" placeholder='{
  "apiKey": "sua-api-key",
  "authDomain": "seu-projeto.firebaseapp.com",
  "databaseURL": "https://seu-projeto.firebaseio.com",
  "projectId": "seu-projeto",
  "storageBucket": "seu-projeto.appspot.com",
  "messagingSenderId": "123456789",
  "appId": "1:123456789:web:abc123"
}'></textarea>
</div>

<div class="modal-buttons">
<button class="modal-btn cancel" onclick="closeConfigModal()">Cancelar</button>
<button class="modal-btn confirm" onclick="saveFirebaseConfig()">Salvar e Conectar</button>
</div>
</div>
</div>

<!-- Modal Confirma√ß√£o -->
<div class="modal" id="modal">
<div class="modal-content">
<h2>Confirmar Presen√ßa</h2>

<div class="form-group">
<label>Jogador</label>
<select id="playerName"></select>
</div>

<div class="form-group">
<input type="checkbox" id="isGuest"> Adicionar convidado
</div>

<div class="form-group" id="guestNameGroup" style="display:none">
<label>Nome do Convidado</label>
<input id="guestName">
</div>

<div class="form-group" id="guestPhoneGroup" style="display:none">
<label>Telefone do Convidado</label>
<input id="guestPhone">
</div>

<div class="modal-buttons">
<button class="modal-btn cancel" id="btnCancelar">Cancelar</button>
<button class="modal-btn confirm" id="btnConfirmarModal">Confirmar</button>
</div>
</div>
</div>

<script type="module">
// Import Firebase
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
import { getDatabase, ref, set, onValue, remove, push } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

const LIMITE_VAGAS = 20;
const jogadores = ["Amarildo","Boy","Buiu","Caio","Charles","Cleversson","Davi","Gera","Diego","Dos Anjos","Eduardo","Fernando","Gregory","Gaspar","Guilherme","Guti","Igor","Izidio","Jean","Jean Rebuy","Junior","Leo","Loreto","Lucas","Matheus","Maykon","Neto","Nil","Peterson","Rafael","Ricardo Amarante","Ricardo Linhares","Ricardo Matoso","Robson","Sergio","Solano","Tigre","Van Van","Waltinho","Wesley"];

let db;
let confirmados = [];
let listaEspera = [];
let firebaseInitialized = false;

const modal = document.getElementById('modal');
const selectJogador = document.getElementById('playerName');

// Preencher select de jogadores
jogadores.forEach(j => {
  const o = document.createElement('option');
  o.value = o.textContent = j;
  selectJogador.appendChild(o);
});

// Verificar configura√ß√£o salva
window.addEventListener('DOMContentLoaded', () => {
  const savedConfig = localStorage.getItem('firebaseConfig');
  if (savedConfig) {
    try {
      const config = JSON.parse(savedConfig);
      initFirebase(config);
    } catch (e) {
      console.error('Erro ao carregar configura√ß√£o:', e);
    }
  }
});

window.openConfigModal = () => {
  document.getElementById('configModal').classList.add('active');
};

window.closeConfigModal = () => {
  document.getElementById('configModal').classList.remove('active');
};

window.saveFirebaseConfig = () => {
  const configText = document.getElementById('firebaseConfigInput').value.trim();
  try {
    const config = JSON.parse(configText);
    localStorage.setItem('firebaseConfig', configText);
    initFirebase(config);
    closeConfigModal();
  } catch (e) {
    alert('‚ùå Configura√ß√£o inv√°lida! Verifique o JSON.');
  }
};

function initFirebase(config) {
  try {
    const app = initializeApp(config);
    db = getDatabase(app);
    firebaseInitialized = true;
    
    document.getElementById('configBanner').style.display = 'none';
    document.getElementById('appContent').style.display = 'block';
    
    // Escutar mudan√ßas em tempo real
    const confirmadosRef = ref(db, 'confirmados');
    const esperaRef = ref(db, 'listaEspera');
    
    onValue(confirmadosRef, (snapshot) => {
      confirmados = snapshot.val() ? Object.values(snapshot.val()) : [];
      atualizar();
      verificarQuartaFeira();
    });
    
    onValue(esperaRef, (snapshot) => {
      listaEspera = snapshot.val() ? Object.values(snapshot.val()) : [];
      atualizar();
    });
    
  } catch (e) {
    document.getElementById('configBanner').classList.add('error');
    document.getElementById('configMessage').textContent = '‚ùå Erro na configura√ß√£o do Firebase';
    document.getElementById('configStatus').textContent = e.message;
    firebaseInitialized = false;
  }
}

btnConfirmar.onclick = () => {
  if (!firebaseInitialized) return alert('Configure o Firebase primeiro!');
  modal.classList.add('active');
};

btnCancelar.onclick = () => modal.classList.remove('active');

isGuest.onchange = e => {
  guestNameGroup.style.display = guestPhoneGroup.style.display = e.target.checked ? 'block' : 'none';
};

btnConfirmarModal.onclick = async () => {
  if (!firebaseInitialized) return alert('Firebase n√£o configurado!');
  
  if (!confirm('Voc√™ est√° se inscrevendo na etapa do Poker de Quinta.\nLeia o Regulamento.')) return;

  const nome = playerName.value;
  if (!nome) return alert('Selecione o jogador');

  // Bloqueio de inscri√ß√£o duplicada (apenas para jogador principal)
  if (!isGuest.checked) {
    if (confirmados.find(p => p.nome === nome && !p.isGuest) || listaEspera.find(p => p.nome === nome && !p.isGuest)) {
      return alert('Este jogador j√° est√° inscrito!');
    }
  }

  const agora = new Date().toISOString();

  try {
    // Se n√£o for s√≥ convidado, adiciona o jogador
    if (!isGuest.checked) {
      const lista = confirmados.length < LIMITE_VAGAS ? 'confirmados' : 'listaEspera';
      const novoRef = push(ref(db, lista));
      await set(novoRef, {
        id: novoRef.key,
        nome,
        isGuest: false,
        guestOf: null,
        data: agora
      });
    }

    // Adiciona convidado se marcado
    if (isGuest.checked) {
      if (!guestName.value) return alert('Informe o nome do convidado');
      const novoRef = push(ref(db, 'listaEspera'));
      await set(novoRef, {
        id: novoRef.key,
        nome: guestName.value,
        telefone: guestPhone.value,
        isGuest: true,
        guestOf: nome,
        data: agora
      });
    }

    modal.classList.remove('active');
    guestName.value = '';
    guestPhone.value = '';
    isGuest.checked = false;
    guestNameGroup.style.display = 'none';
    guestPhoneGroup.style.display = 'none';
  } catch (e) {
    alert('Erro ao confirmar: ' + e.message);
  }
};

function formatarData(iso) {
  const d = new Date(iso);
  return d.toLocaleDateString('pt-BR') + ' √†s ' + d.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
}

window.remover = async (id, isWait) => {
  if (!firebaseInitialized) return;
  
  const lista = isWait ? listaEspera : confirmados;
  const player = lista.find(p => p.id === id);
  if (!player) return;

  if (!confirm(`Remover ${player.nome}?`)) return;

  try {
    const path = isWait ? 'listaEspera' : 'confirmados';
    await remove(ref(db, `${path}/${id}`));

    // Remover convidados associados
    if (!isWait) {
      const convidadosAssociados = listaEspera.filter(p => p.guestOf === player.nome);
      for (const conv of convidadosAssociados) {
        await remove(ref(db, `listaEspera/${conv.id}`));
      }

      // Puxar pr√≥ximo membro da espera
      const proximoMembroIdx = listaEspera.findIndex(p => jogadores.includes(p.nome) && !p.isGuest);
      if (proximoMembroIdx !== -1) {
        const membro = listaEspera[proximoMembroIdx];
        await remove(ref(db, `listaEspera/${membro.id}`));
        const novoRef = push(ref(db, 'confirmados'));
        await set(novoRef, { ...membro, id: novoRef.key });
      }
    }
  } catch (e) {
    alert('Erro ao remover: ' + e.message);
  }
};

function atualizar() {
  confirmedCount.textContent = confirmados.length;
  vacancyCount.textContent = LIMITE_VAGAS - confirmados.length;
  waitlistCount.textContent = listaEspera.length;

  // Ordenar lista de espera
  listaEspera.sort((a, b) => {
    const aIsMembro = jogadores.includes(a.nome);
    const bIsMembro = jogadores.includes(b.nome);
    if (aIsMembro && !bIsMembro) return -1;
    if (!aIsMembro && bIsMembro) return 1;
    return new Date(a.data) - new Date(b.data);
  });

  confirmedList.innerHTML = confirmados.length ? '' : '<li class="empty-state">Nenhuma confirma√ß√£o</li>';
  confirmados.forEach((p, i) => {
    const isMembro = jogadores.includes(p.nome);
    confirmedList.innerHTML += `
    <li class="player-item">
      <div class="player-info">
        <div class="player-number">${i + 1}¬∫</div>
        <div class="player-details">
          <strong>${p.nome}</strong>
          <small>üïí ${formatarData(p.data)}</small>
        </div>
      </div>
      ${isMembro ? '<span class="player-badge member">MEMBRO</span>' : ''}
      <button class="remove-btn" onclick="remover('${p.id}',false)">‚ùå</button>
    </li>`;
  });

  waitlistList.innerHTML = listaEspera.length ? '' : '<li class="empty-state">Nenhum jogador</li>';
  listaEspera.forEach((p, i) => {
    const isMembro = jogadores.includes(p.nome);
    const badgeClass = p.isGuest ? 'guest' : (isMembro ? 'member' : 'wait');
    const badgeText = p.isGuest ? 'CONVIDADO' : (isMembro ? 'MEMBRO' : 'ESPERA');
    waitlistList.innerHTML += `
    <li class="player-item">
      <div class="player-info">
        <div class="player-number">${i + 1}¬∫</div>
        <div class="player-details">
          <strong>${p.nome}</strong>
          <small>üïí ${formatarData(p.data)}</small>
          ${p.guestOf ? `<small>üë§ Convidado de ${p.guestOf}</small>` : ''}
        </div>
      </div>
      <span class="player-badge ${badgeClass}">${badgeText}</span>
      <button class="remove-btn" onclick="remover('${p.id}',true)">‚ùå</button>
    </li>`;
  });
}

btnExportar.onclick = () => {
  let csv = 'Posi√ß√£o,Nome,Status,Data/Hora,Convidado de,Telefone\n';
  confirmados.forEach((p, i) => {
    csv += `${i + 1},"${p.nome}",CONFIRMADO,"${formatarData(p.data)}","",""\n`;
  });
  listaEspera.forEach((p, i) => {
    const status = p.isGuest ? 'CONVIDADO' : 'ESPERA';
    csv += `${i + 1},"${p.nome}",${status},"${formatarData(p.data)}","${p.guestOf || ''}","${p.telefone || ''}"\n`;
  });
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = 'poker_de_quinta_29-01-2026.csv';
  link.click();
};

async function verificarQuartaFeira() {
  if (!firebaseInitialized) return;
  
  const agora = new Date();
  const dataEvento = new Date('2026-01-29');
  const quartaAntes = new Date(dataEvento);
  quartaAntes.setDate(dataEvento.getDate() - 1);
  quartaAntes.setHours(10, 0, 0, 0);

  if (agora >= quartaAntes && confirmados.length < LIMITE_VAGAS && listaEspera.length > 0) {
    const ultimaExec = localStorage.getItem('ultimaExecQuarta');
    const hoje = agora.toDateString();
    if (ultimaExec !== hoje) {
      try {
        // Primeiro: puxar MEMBROS
        while (confirmados.length < LIMITE_VAGAS && listaEspera.length > 0) {
          const idx = listaEspera.findIndex(p => jogadores.includes(p.nome) && !p.isGuest);
          if (idx !== -1) {
            const membro = listaEspera[idx];
            await remove(ref(db, `listaEspera/${membro.id}`));
            const novoRef = push(ref(db, 'confirmados'));
            await set(novoRef, { ...membro, id: novoRef.key });
          } else {
            break;
          }
        }
        
        // Depois: puxar CONVIDADOS se ainda houver vagas
        while (confirmados.length < LIMITE_VAGAS && listaEspera.length > 0) {
          const convidado = listaEspera[0];
          await remove(ref(db, `listaEspera/${convidado.id}`));
          const novoRef = push(ref(db, 'confirmados'));
          await set(novoRef, { ...convidado, id: novoRef.key });
        }
        
        localStorage.setItem('ultimaExecQuarta', hoje);
      } catch (e) {
        console.error('Erro na regra de quarta-feira:', e);
      }
    }
  }
}
</script>

</body>
</html>
