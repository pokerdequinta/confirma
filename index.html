<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Confirma√ß√£o de Presen√ßa - 1¬™ Etapa</title>

<style>
@import url('https://fonts.googleapis.com/css2?family=Anton&display=swap');
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Segoe UI',Tahoma;background:#0d1b0d;color:#fff;min-height:100vh}
.logo-top{text-align:center;padding:20px}
.logo-top img{max-width:200px}
.container{max-width:1000px;margin:auto;padding:20px}
header{text-align:center;background:#102810;border:2px solid #d4a121;border-radius:15px;padding:30px;margin-bottom:30px}
h1{font-family:'Anton';color:#d4a121;letter-spacing:3px}
.subtitle{margin-top:10px}
.info-cards{display:grid;grid-template-columns:repeat(3,1fr);gap:15px;margin-bottom:25px}
.info-card{background:#102810;border:2px solid #d4a121;border-radius:12px;padding:20px;text-align:center}
.info-card h2{font-family:'Anton';font-size:2.5em;color:#d4a121}
.add-btn{width:100%;padding:15px;background:#d4a121;border:none;border-radius:10px;font-weight:bold;cursor:pointer;margin-bottom:10px;color:#000}
.cancel-btn-main{width:100%;padding:15px;background:#c72c48;border:none;border-radius:10px;font-weight:bold;cursor:pointer;margin-bottom:20px;color:#fff}
.add-btn:disabled{opacity:0.5;cursor:not-allowed}
.export-btn{background:#2d5016;color:#fff}
.section{background:#102810;border:2px solid #d4a121;border-radius:12px;padding:20px;margin-bottom:25px}
.player-list{list-style:none}
.player-item{display:flex;justify-content:space-between;align-items:center;background:rgba(255,255,255,.05);padding:15px;border-radius:10px;margin-bottom:10px;gap:10px}
.player-info{display:flex;gap:15px;align-items:center}
.player-number{font-family:'Anton';color:#d4a121}
.player-details{display:flex;flex-direction:column}
.player-details small{opacity:.85}
.player-badge{background:#d4a121;color:#000;padding:4px 10px;border-radius:20px;font-size:.8em;font-weight:bold}
.wait{background:#c72c48;color:#fff}
.guest{background:#4CAF50;color:#000}
.member{background:#1E90FF;color:#fff}
.remove-btn{background:#c72c48;color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer}
.empty-state{text-align:center;opacity:.7;padding:30px}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.8);justify-content:center;align-items:center;z-index:1000}
.modal.active{display:flex}
.modal-content{background:#102810;border:2px solid #d4a121;border-radius:15px;padding:30px;width:90%;max-width:500px}
.form-group{margin-bottom:15px}
.form-group label{color:#d4a121;font-weight:bold;display:block;margin-bottom:5px}
.form-group input,.form-group select{width:100%;padding:10px;border-radius:8px;border:1px solid #2d5016;background:#1a3d1a;color:#fff}
.modal-buttons{display:flex;gap:10px;margin-top:20px}
.modal-btn{flex:1;padding:10px;font-weight:bold;border:none;border-radius:8px;cursor:pointer}
.modal-btn.confirm{background:#d4a121;color:#000}
.modal-btn.cancel{background:#c72c48;color:#fff}
.loading{text-align:center;padding:20px;opacity:0.7}
.status-indicator{position:fixed;top:10px;right:10px;background:#2d5016;padding:8px 15px;border-radius:20px;font-size:0.85em;border:1px solid #d4a121}
.status-indicator.connected{background:#1a3d1a;border-color:#4CAF50}
.status-indicator.error{background:#3d1a1a;border-color:#c72c48}
@media(max-width:768px){
.info-cards{grid-template-columns:1fr}
}
</style>
</head>

<body>

<div class="status-indicator" id="statusIndicator">üîÑ Conectando...</div>

<div class="logo-top">
<img src="logo pdq.png" onerror="this.style.display='none'">
</div>

<div class="container">

<header>
<h1>POKER DE QUINTA</h1>
<div class="subtitle">üìÖ 1¬™ Etapa - 29/01/2026</div>
</header>

<div class="info-cards">
<div class="info-card"><h2 id="confirmedCount">0</h2>Confirmados</div>
<div class="info-card"><h2 id="vacancyCount">20</h2>Vagas</div>
<div class="info-card"><h2 id="waitlistCount">0</h2>Espera</div>
</div>

<button class="add-btn" id="btnConfirmar">‚ûï CONFIRMAR PRESEN√áA</button>
<button class="cancel-btn-main" id="btnCancelarWhatsApp">‚ùå CANCELAR MINHA INSCRI√á√ÉO</button>
<button class="add-btn export-btn" id="btnExportar">üìä EXPORTAR CSV</button>

<div class="section">
<h3>‚úÖ CONFIRMADOS</h3>
<ul id="confirmedList" class="player-list">
<li class="loading">Carregando dados...</li>
</ul>
</div>

<div class="section">
<h3>‚è≥ LISTA DE ESPERA</h3>
<ul id="waitlistList" class="player-list">
<li class="loading">Carregando dados...</li>
</ul>
</div>

</div>

<button class="add-btn" id="btnModoAdmin" style="position:fixed;bottom:10px;right:10px;width:auto;padding:8px 15px;background:rgba(13,27,13,0.3);border:1px solid rgba(212,161,33,0.1);opacity:0.15;font-size:0.7em;transition:opacity 0.3s">üîê</button>

<div class="modal" id="modalAdmin">
<div class="modal-content">
<h2 style="color: #8b0000;">üîê Modo Administrador</h2>
<p style="margin: 15px 0; opacity: 0.8;">Digite a senha de administrador para acessar fun√ß√µes exclusivas:</p>
<div class="form-group">
<label>Senha Admin</label>
<input type="password" id="senhaAdmin" placeholder="Digite a senha">
</div>
<div class="modal-buttons">
<button class="modal-btn cancel" id="btnFecharAdmin">Cancelar</button>
<button class="modal-btn confirm" id="btnAcessarAdmin" style="background:#8b0000; color:#fff">Acessar</button>
</div>
</div>
</div>

<div class="modal" id="modalBemVindo">
<div class="modal-content">
<h2 style="color: #d4a121;">üìã Bem-vindo ao Poker de Quinta!</h2>
<p style="margin: 15px 0; line-height: 1.6;">
Esta √© a p√°gina oficial de inscri√ß√£o do <strong>Poker de Quinta</strong>.<br><br>
‚úÖ Para se inscrever, clique no bot√£o <strong>"CONFIRMAR PRESEN√áA"</strong>.<br><br>
‚ùå Se precisar cancelar sua inscri√ß√£o, clique no bot√£o <strong>"CANCELAR MINHA INSCRI√á√ÉO"</strong> que abrir√° o WhatsApp para voc√™ solicitar a remo√ß√£o da lista.
</p>
<div class="modal-buttons">
<button class="modal-btn confirm" id="btnEntendi" style="width:100%">Entendi!</button>
</div>
</div>
</div>

<div class="modal" id="modal">
<div class="modal-content">
<h2>Confirmar Presen√ßa</h2>
<div class="form-group">
<label>Jogador</label>
<select id="playerName"></select>
</div>
<div class="form-group">
<input type="checkbox" id="isGuest"> Adicionar convidado
</div>
<div class="form-group" id="guestNameGroup" style="display:none">
<label>Nome do Convidado</label>
<input id="guestName">
</div>
<div class="form-group" id="guestPhoneGroup" style="display:none">
<label>Telefone do Convidado</label>
<input id="guestPhone">
</div>
<div class="modal-buttons">
<button class="modal-btn cancel" id="btnCancelar">Cancelar</button>
<button class="modal-btn confirm" id="btnConfirmarModal">Confirmar</button>
</div>
</div>
</div>

<div class="modal" id="modalCancelar">
<div class="modal-content">
<h2 style="color: #c72c48;">Cancelar Inscri√ß√£o</h2>
<p style="margin: 10px 0; font-size: 0.9em; opacity: 0.8;">Seu nome ser√° removido e o organizador ser√° notificado via WhatsApp.</p>
<div class="form-group">
<label>Selecione seu Nome</label>
<select id="cancelPlayerName"></select>
</div>
<div class="modal-buttons">
<button class="modal-btn cancel" id="btnFecharCancelar">Voltar</button>
<button class="modal-btn confirm" id="btnExecutarCancelamento" style="background:#c72c48; color:#fff">Confirmar Sa√≠da</button>
</div>
</div>
</div>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
import { getDatabase, ref, set, onValue, remove, push } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

const firebaseConfig = {
  apiKey: "AIzaSyD_XXjcjJYM73wLTTzpDgzKCOZnztcJhjE",
  authDomain: "poker-de-quinta.firebaseapp.com",
  databaseURL: "https://poker-de-quinta-default-rtdb.firebaseio.com",
  projectId: "poker-de-quinta",
  storageBucket: "poker-de-quinta.firebasestorage.app",
  messagingSenderId: "776724152456",
  appId: "1:776724152456:web:fbffde9a1c1a7628c61f3d"
};

const LIMITE_VAGAS = 20;
const TELEFONE_ORGANIZADOR = "5541987210685";
const SENHA_ADMIN = "poker2026"; // ALTERE ESTA SENHA
const jogadores = ["Amarildo","Boy","Buiu","Caio","Charles","Cleversson","Davi","Gera","Diego","Dos Anjos","Eduardo","Fernando","Gregory","Gaspar","Guilherme","Guti","Igor","Izidio","Jean","Jean Rebuy","Junior","Leo","Loreto","Lucas","Matheus","Maykon","Neto","Nil","Peterson","Rafael","Ricardo Amarante","Ricardo Linhares","Ricardo Matoso","Robson","Sergio","Solano","Tigre","Van Van","Waltinho","Wesley"];

let db;
let confirmados = [];
let listaEspera = [];
let modoAdmin = false;

const modal = document.getElementById('modal');
const modalBemVindo = document.getElementById('modalBemVindo');
const modalAdmin = document.getElementById('modalAdmin');
const selectJogador = document.getElementById('playerName');
const statusIndicator = document.getElementById('statusIndicator');
const senhaAdminInput = document.getElementById('senhaAdmin');

// Mostrar popup de boas-vindas ao carregar a p√°gina
window.addEventListener('load', () => {
  modalBemVindo.classList.add('active');
});

btnEntendi.onclick = () => {
  modalBemVindo.classList.remove('active');
};

// Preencher selects com op√ß√£o padr√£o
const opcaoPadrao1 = document.createElement('option');
opcaoPadrao1.value = '';
opcaoPadrao1.textContent = '-- Selecione seu nome --';
opcaoPadrao1.disabled = true;
opcaoPadrao1.selected = true;
selectJogador.appendChild(opcaoPadrao1);

jogadores.forEach(j => {
  const o1 = document.createElement('option');
  o1.value = o1.textContent = j;
  selectJogador.appendChild(o1);
});

try {
  const app = initializeApp(firebaseConfig);
  db = getDatabase(app);
  statusIndicator.textContent = '‚úÖ Conectado';
  statusIndicator.classList.add('connected');
  
  onValue(ref(db, 'confirmados'), (snapshot) => {
    confirmados = [];
    if (snapshot.exists()) snapshot.forEach(child => { confirmados.push(child.val()); });
    atualizar();
    verificarQuartaFeira();
  });
  
  onValue(ref(db, 'listaEspera'), (snapshot) => {
    listaEspera = [];
    if (snapshot.exists()) snapshot.forEach(child => { listaEspera.push(child.val()); });
    atualizar();
  });
} catch (e) {
  statusIndicator.textContent = '‚ùå Erro de conex√£o';
  statusIndicator.classList.add('error');
}

// Fun√ß√µes de Modal
btnConfirmar.onclick = () => modal.classList.add('active');
btnCancelar.onclick = () => modal.classList.remove('active');

// Modal Admin
btnModoAdmin.onclick = () => {
  if (modoAdmin) {
    modoAdmin = false;
    btnModoAdmin.innerHTML = 'üîê';
    btnModoAdmin.style.background = 'rgba(13,27,13,0.3)';
    btnModoAdmin.style.border = '1px solid rgba(212,161,33,0.1)';
    btnModoAdmin.style.opacity = '0.15';
    btnModoAdmin.style.fontSize = '0.7em';
    alert('Modo Admin desativado!');
    atualizar();
  } else {
    modalAdmin.classList.add('active');
    senhaAdminInput.value = '';
    senhaAdminInput.focus();
  }
};

// Hover no bot√£o admin para ficar mais vis√≠vel
btnModoAdmin.addEventListener('mouseenter', () => {
  if (!modoAdmin) btnModoAdmin.style.opacity = '0.5';
});

btnModoAdmin.addEventListener('mouseleave', () => {
  if (!modoAdmin) btnModoAdmin.style.opacity = '0.15';
});

btnFecharAdmin.onclick = () => modalAdmin.classList.remove('active');

btnAcessarAdmin.onclick = () => {
  if (senhaAdminInput.value === SENHA_ADMIN) {
    modoAdmin = true;
    modalAdmin.classList.remove('active');
    btnModoAdmin.innerHTML = 'üîì ADMIN';
    btnModoAdmin.style.background = '#4CAF50';
    btnModoAdmin.style.border = '2px solid #2d7a2d';
    btnModoAdmin.style.opacity = '1';
    btnModoAdmin.style.fontSize = '0.85em';
    alert('‚úÖ Modo Admin ativado! Agora voc√™ pode remover qualquer jogador.');
    atualizar();
  } else {
    alert('‚ùå Senha incorreta!');
    senhaAdminInput.value = '';
    senhaAdminInput.focus();
  }
};

// Permitir Enter para acessar admin
senhaAdminInput.addEventListener('keypress', (e) => {
  if (e.key === 'Enter') btnAcessarAdmin.click();
});

// Bot√£o de cancelamento via WhatsApp
btnCancelarWhatsApp.onclick = () => {
  const mensagem = encodeURIComponent(
    'Ol√°! Gostaria de cancelar minha inscri√ß√£o no Poker de Quinta.\n\n' +
    'Meu nome: [DIGITE SEU NOME AQUI]\n\n' +
    'Obrigado!'
  );
  window.open(`https://wa.me/5541987210685?text=${mensagem}`, '_blank');
};

isGuest.onchange = e => {
  guestNameGroup.style.display = guestPhoneGroup.style.display = e.target.checked ? 'block' : 'none';
};

// Confirmar Presen√ßa
btnConfirmarModal.onclick = async () => {
  const nome = playerName.value;
  
  if (!nome) {
    return alert('Por favor, selecione seu nome!');
  }
  
  if (!confirm('Voc√™ est√° se inscrevendo na etapa do Poker de Quinta.')) return;
  if (!isGuest.checked && (confirmados.find(p => p.nome === nome) || listaEspera.find(p => p.nome === nome))) {
    return alert('Este jogador j√° est√° inscrito!');
  }
  const agora = new Date().toISOString();
  try {
    if (!isGuest.checked) {
      const lista = confirmados.length < LIMITE_VAGAS ? 'confirmados' : 'listaEspera';
      const novoRef = push(ref(db, lista));
      await set(novoRef, { id: novoRef.key, nome, isGuest: false, data: agora });
    }
    if (isGuest.checked) {
      if (!guestName.value) return alert('Informe o nome do convidado');
      const novoRef = push(ref(db, 'listaEspera'));
      await set(novoRef, { id: novoRef.key, nome: guestName.value, telefone: guestPhone.value, isGuest: true, guestOf: nome, data: agora });
    }
    modal.classList.remove('active');
  } catch (e) { alert('Erro: ' + e.message); }
};

// Fun√ß√£o para notificar via WhatsApp (corrigida para mobile)
function notificarCancelamento(nomeJogador, statusAnterior) {
  const dataHora = new Date().toLocaleString('pt-BR');
  const statusTexto = statusAnterior === 'confirmado' ? 'CONFIRMADOS' : 'LISTA DE ESPERA';
  
  const mensagem = `üö® CANCELAMENTO - Poker de Quinta

Jogador: ${nomeJogador}
Status anterior: ${statusTexto}
Data/Hora: ${dataHora}

O jogador cancelou sua inscri√ß√£o.`;

  // Codifica a mensagem para URL
  const mensagemCodificada = encodeURIComponent(mensagem);
  const urlWhatsApp = `https://wa.me/${TELEFONE_ORGANIZADOR}?text=${mensagemCodificada}`;
  
  // Abre em nova aba/janela
  window.open(urlWhatsApp, '_blank');
}

// Fun√ß√£o de remover jogadores (agora funciona em modo admin)
window.removerJogador = async (id, isWait) => {
  try {
    const listaAtual = isWait ? listaEspera : confirmados;
    const player = listaAtual.find(p => p.id === id);
    
    if (!player) return;
    
    // Se n√£o for convidado e n√£o estiver em modo admin, bloqueia
    if (!player.isGuest && !modoAdmin) {
      alert('‚ö†Ô∏è Apenas convidados podem ser removidos. Para remover membros, ative o Modo Admin.');
      return;
    }
    
    if (!confirm(`Remover ${player.nome}?`)) return;

    const path = isWait ? 'listaEspera' : 'confirmados';
    await remove(ref(db, `${path}/${id}`));
    
    // Remove convidados associados se estava nos confirmados
    if (!isWait && !player.isGuest) {
      const convidados = listaEspera.filter(p => p.guestOf === player.nome);
      for (const conv of convidados) {
        await remove(ref(db, `listaEspera/${conv.id}`));
      }
      
      // Promove pr√≥ximo da lista de espera SOMENTE SE FOR QUARTA-FEIRA AP√ìS AS 10h
      const agora = new Date();
      const diaSemana = agora.getDay();
      const hora = agora.getHours();
      
      if (diaSemana === 3 && hora >= 10) {
        const proximo = listaEspera.find(p => jogadores.includes(p.nome) && !p.isGuest);
        if (proximo) {
          await remove(ref(db, `listaEspera/${proximo.id}`));
          const novoRef = push(ref(db, 'confirmados'));
          await set(novoRef, { ...proximo, id: novoRef.key });
        }
      }
    }
    
    // Notifica organizador se for modo admin removendo membro
    if (!player.isGuest && modoAdmin) {
      notificarCancelamento(player.nome, isWait ? 'espera' : 'confirmado');
    }
    
  } catch (e) { 
    console.error(e);
    alert('Erro ao remover: ' + e.message);
  }
};

function formatarData(iso) {
  const d = new Date(iso);
  return d.toLocaleDateString('pt-BR') + ' ' + d.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
}

function atualizar() {
  confirmedCount.textContent = confirmados.length;
  vacancyCount.textContent = Math.max(0, LIMITE_VAGAS - confirmados.length);
  waitlistCount.textContent = listaEspera.length;

  confirmedList.innerHTML = confirmados.length ? '' : '<li class="empty-state">Nenhuma confirma√ß√£o</li>';
  confirmados.forEach((p, i) => {
    const isMembro = jogadores.includes(p.nome);
    const isConvidado = p.isGuest;
    
    // Bot√£o X aparece para CONVIDADOS sempre, ou para TODOS se estiver em modo admin
    const mostrarBotao = isConvidado || modoAdmin;
    const btnRemover = mostrarBotao ? `<button class="remove-btn" onclick="removerJogador('${p.id}',false)">‚ùå</button>` : '';
    
    confirmedList.innerHTML += `<li class="player-item">
        <div class="player-info"><div class="player-number">${i+1}¬∫</div>
        <div class="player-details"><strong>${p.nome}</strong><small>üïí ${formatarData(p.data)}</small></div></div>
        ${isMembro ? '<span class="player-badge member">MEMBRO</span>' : ''}
        ${isConvidado ? '<span class="player-badge guest">CONVIDADO</span>' : ''}
        ${btnRemover}</li>`;
  });

  waitlistList.innerHTML = listaEspera.length ? '' : '<li class="empty-state">Nenhum jogador</li>';
  listaEspera.forEach((p, i) => {
    const isMembro = jogadores.includes(p.nome);
    const isConvidado = p.isGuest;
    
    // Bot√£o X aparece para CONVIDADOS sempre, ou para TODOS se estiver em modo admin
    const mostrarBotao = isConvidado || modoAdmin;
    const btnRemover = mostrarBotao ? `<button class="remove-btn" onclick="removerJogador('${p.id}',true)">‚ùå</button>` : '';
    
    const badge = isConvidado ? 'guest' : (isMembro ? 'member' : 'wait');
    const badgeText = isConvidado ? 'CONVIDADO' : 'ESPERA';
    
    waitlistList.innerHTML += `<li class="player-item">
        <div class="player-info"><div class="player-number">${i+1}¬∫</div>
        <div class="player-details"><strong>${p.nome}</strong><small>üïí ${formatarData(p.data)}</small>
        ${p.guestOf ? `<small>üë§ De: ${p.guestOf}</small>` : ''}</div></div>
        <span class="player-badge ${badge}">${badgeText}</span>
        ${btnRemover}</li>`;
  });
}

btnExportar.onclick = () => {
  let csv = 'Posi√ß√£o,Nome,Status\n';
  confirmados.forEach((p, i) => csv += `${i + 1},${p.nome},CONFIRMADO\n`);
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = 'poker_lista.csv';
  link.click();
};

async function verificarQuartaFeira() {
  const agora = new Date();
  const diaSemana = agora.getDay();
  const hora = agora.getHours();
  
  // S√≥ executa na quarta-feira (dia 3) AP√ìS as 10h
  if (diaSemana === 3 && hora >= 10) {
    // L√≥gica original de promo√ß√£o autom√°tica de membros
    const listaMembrosPendentes = listaEspera.filter(p => jogadores.includes(p.nome) && !p.isGuest);
    
    for (const membro of listaMembrosPendentes) {
      if (confirmados.length < LIMITE_VAGAS) {
        try {
          await remove(ref(db, `listaEspera/${membro.id}`));
          const novoRef = push(ref(db, 'confirmados'));
          await set(novoRef, { ...membro, id: novoRef.key });
        } catch (e) {
          console.error('Erro ao promover membro:', e);
        }
      }
    }
  }
}
</script>
</body>
</html>
