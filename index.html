<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Confirma√ß√£o de Presen√ßa - 1¬™ Etapa</title>

<style>
@import url('https://fonts.googleapis.com/css2?family=Anton&display=swap');
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Segoe UI',Tahoma;background:#0d1b0d;color:#fff;min-height:100vh}
.logo-top{text-align:center;padding:20px}
.logo-top img{max-width:200px}
.container{max-width:1000px;margin:auto;padding:20px}
header{text-align:center;background:#102810;border:2px solid #d4a121;border-radius:15px;padding:30px;margin-bottom:30px}
h1{font-family:'Anton';color:#d4a121;letter-spacing:3px}
.subtitle{margin-top:10px}
.info-cards{display:grid;grid-template-columns:repeat(3,1fr);gap:15px;margin-bottom:25px}
.info-card{background:#102810;border:2px solid #d4a121;border-radius:12px;padding:20px;text-align:center}
.info-card h2{font-family:'Anton';font-size:2.5em;color:#d4a121}

.add-btn{width:100%;padding:15px;background:#d4a121;border:none;border-radius:10px;font-weight:bold;cursor:pointer;margin-bottom:10px;color:#000}
.cancel-btn-main{width:100%;padding:15px;background:#c72c48;border:none;border-radius:10px;font-weight:bold;cursor:pointer;margin-bottom:20px;color:#fff}
.export-btn{background:#2d5016;margin-top:10px; color:#fff}

.section{background:#102810;border:2px solid #d4a121;border-radius:12px;padding:20px;margin-bottom:25px}
.player-list{list-style:none}
.player-item{display:flex;justify-content:space-between;align-items:center;background:rgba(255,255,255,.05);padding:15px;border-radius:10px;margin-bottom:10px;gap:10px}
.player-info{display:flex;gap:15px;align-items:center}
.player-number{font-family:'Anton';color:#d4a121}
.player-details{display:flex;flex-direction:column}
.player-details small{opacity:.85}
.player-badge{background:#d4a121;color:#000;padding:4px 10px;border-radius:20px;font-size:.8em;font-weight:bold}
.wait{background:#c72c48;color:#fff}
.guest{background:#4CAF50;color:#000}
.member{background:#1E90FF;color:#fff}

/* Seguran√ßa: Bot√£o de remover oculto para evitar remo√ß√µes acidentais */
.remove-btn{display:none} 

.empty-state{text-align:center;opacity:.7;padding:30px}

.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.8);justify-content:center;align-items:center;z-index:1000}
.modal.active{display:flex}
.modal-content{background:#102810;border:2px solid #d4a121;border-radius:15px;padding:30px;width:90%;max-width:500px}
.form-group{margin-bottom:15px}
.form-group label{color:#d4a121;font-weight:bold;display:block;margin-bottom:5px}
.form-group input,.form-group select{width:100%;padding:10px;border-radius:8px;border:1px solid #2d5016;background:#1a3d1a;color:#fff}
.modal-buttons{display:flex;gap:10px;margin-top:20px}
.modal-btn{flex:1;padding:10px;font-weight:bold;border:none;border-radius:8px;cursor:pointer}
.modal-btn.confirm{background:#d4a121;color:#000}
.modal-btn.cancel{background:#c72c48;color:#fff}

.status-indicator{position:fixed;top:10px;right:10px;background:#2d5016;padding:8px 15px;border-radius:20px;font-size:0.85em;border:1px solid #d4a121}
.status-indicator.connected{background:#1a3d1a;border-color:#4CAF50}
@media(max-width:768px){ .info-cards{grid-template-columns:1fr} }
</style>
</head>
<body>

<div class="status-indicator" id="statusIndicator">üîÑ Conectando...</div>

<div class="logo-top">
    <img src="logo pdq.png" onerror="this.style.display='none'">
</div>

<div class="container">
    <header>
        <h1>POKER DE QUINTA</h1>
        <div class="subtitle">üìÖ 1¬™ Etapa - 29/01/2026</div>
    </header>

    <div class="info-cards">
        <div class="info-card"><h2 id="confirmedCount">0</h2>Confirmados</div>
        <div class="info-card"><h2 id="vacancyCount">20</h2>Vagas</div>
        <div class="info-card"><h2 id="waitlistCount">0</h2>Espera</div>
    </div>

    <button class="add-btn" id="btnConfirmar">‚ûï CONFIRMAR PRESEN√áA</button>
    <button class="cancel-btn-main" id="btnAbrirCancelar">‚ùå CANCELAR MINHA INSCRI√á√ÉO</button>
    <button class="add-btn export-btn" id="btnExportar">üìä EXPORTAR CSV</button>

    <div class="section">
        <h3>‚úÖ CONFIRMADOS</h3>
        <ul id="confirmedList" class="player-list"><li class="empty-state">Carregando...</li></ul>
    </div>

    <div class="section">
        <h3>‚è≥ LISTA DE ESPERA</h3>
        <ul id="waitlistList" class="player-list"><li class="empty-state">Carregando...</li></ul>
    </div>
</div>

<div class="modal" id="modal">
    <div class="modal-content">
        <h2>Confirmar Presen√ßa</h2>
        <div class="form-group">
            <label>Jogador</label>
            <select id="playerName"></select>
        </div>
        <div class="form-group">
            <input type="checkbox" id="isGuest"> Adicionar convidado
        </div>
        <div id="guestFields" style="display:none">
            <div class="form-group"><label>Nome do Convidado</label><input id="guestName"></div>
            <div class="form-group"><label>Telefone do Convidado</label><input id="guestPhone"></div>
        </div>
        <div class="modal-buttons">
            <button class="modal-btn cancel" id="btnCancelar">Voltar</button>
            <button class="modal-btn confirm" id="btnConfirmarModal">Confirmar</button>
        </div>
    </div>
</div>

<div class="modal" id="modalCancelar">
    <div class="modal-content">
        <h2 style="color: #c72c48;">Cancelar Inscri√ß√£o</h2>
        <p style="margin: 10px 0; font-size: 0.9em; opacity: 0.8;">Escolha seu nome para sair da lista. Voc√™ ser√° redirecionado para enviar o aviso ao organizador.</p>
        <div class="form-group">
            <label>Qual nome deseja remover?</label>
            <select id="cancelPlayerName"></select>
        </div>
        <div class="modal-buttons">
            <button class="modal-btn cancel" id="btnFecharCancelar">Voltar</button>
            <button class="modal-btn confirm" id="btnExecutarCancelamento" style="background:#c72c48; color:#fff">Confirmar Sa√≠da</button>
        </div>
    </div>
</div>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
import { getDatabase, ref, set, onValue, remove, push, get } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

const firebaseConfig = {
    apiKey: "AIzaSyD_XXjcjJYM73wLTTzpDgzKCOZnztcJhjE",
    authDomain: "poker-de-quinta.firebaseapp.com",
    databaseURL: "https://poker-de-quinta-default-rtdb.firebaseio.com",
    projectId: "poker-de-quinta",
    storageBucket: "poker-de-quinta.firebasestorage.app",
    messagingSenderId: "776724152456",
    appId: "1:776724152456:web:fbffde9a1c1a7628c61f3d"
};

const LIMITE_VAGAS = 20;
const jogadores = ["Amarildo","Boy","Buiu","Caio","Charles","Cleversson","Davi","Gera","Diego","Dos Anjos","Eduardo","Fernando","Gregory","Gaspar","Guilherme","Guti","Igor","Izidio","Jean","Jean Rebuy","Junior","Leo","Loreto","Lucas","Matheus","Maykon","Neto","Nil","Peterson","Rafael","Ricardo Amarante","Ricardo Linhares","Ricardo Matoso","Robson","Sergio","Solano","Tigre","Van Van","Waltinho","Wesley"];

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let confirmados = [];
let listaEspera = [];

// Preencher selects
const selectInscricao = document.getElementById('playerName');
const selectCancel = document.getElementById('cancelPlayerName');
jogadores.sort().forEach(j => {
    selectInscricao.add(new Option(j, j));
    selectCancel.add(new Option(j, j));
});

// Sincroniza√ß√£o em Tempo Real
onValue(ref(db, 'confirmados'), (snapshot) => {
    confirmados = [];
    if (snapshot.exists()) snapshot.forEach(child => { confirmados.push({...child.val(), id: child.key}); });
    atualizarUI();
    verificarQuartaFeira();
});

onValue(ref(db, 'listaEspera'), (snapshot) => {
    listaEspera = [];
    if (snapshot.exists()) snapshot.forEach(child => { 
        listaEspera.push({...child.val(), id: child.key}); 
    });
    atualizarUI();
});

// A√ß√µes de Bot√µes e Modais
btnConfirmar.onclick = () => document.getElementById('modal').classList.add('active');
btnCancelar.onclick = () => document.getElementById('modal').classList.remove('active');
btnAbrirCancelar.onclick = () => document.getElementById('modalCancelar').classList.add('active');
btnFecharCancelar.onclick = () => document.getElementById('modalCancelar').classList.remove('active');
isGuest.onchange = e => document.getElementById('guestFields').style.display = e.target.checked ? 'block' : 'none';

// Confirmar Presen√ßa
btnConfirmarModal.onclick = async () => {
    const nome = selectInscricao.value;
    if(!isGuest.checked && (confirmados.some(p => p.nome === nome) || listaEspera.some(p => p.nome === nome))) return alert("Jogador j√° est√° na lista!");
    
    const agora = new Date().toISOString();
    try {
        if(!isGuest.checked) {
            const path = confirmados.length < LIMITE_VAGAS ? 'confirmados' : 'listaEspera';
            await push(ref(db, path), { nome, isGuest: false, data: agora });
        } else {
            const gNome = document.getElementById('guestName').value;
            if(!gNome) return alert("Nome do convidado?");
            await push(ref(db, 'listaEspera'), { nome: gNome, isGuest: true, guestOf: nome, data: agora });
        }
        document.getElementById('modal').classList.remove('active');
    } catch (e) { alert("Erro de conex√£o com o banco."); }
};

// LOGICA DE CANCELAMENTO REFINADA
btnExecutarCancelamento.onclick = async () => {
    const nomeAlvo = selectCancel.value;
    
    // Procura em ambas as listas
    const pConf = confirmados.find(p => p.nome === nomeAlvo);
    const pEsp = listaEspera.find(p => p.nome === nomeAlvo);
    const player = pConf || pEsp;

    if(!player) return alert("Jogador n√£o encontrado na lista atual.");
    if(!confirm(`Deseja mesmo cancelar a inscri√ß√£o de ${nomeAlvo}?`)) return;

    try {
        const isWait = !!pEsp;
        const path = isWait ? 'listaEspera' : 'confirmados';

        // 1. Remove do Firebase
        await remove(ref(db, `${path}/${player.id}`));

        // 2. Se saiu dos confirmados, promove o pr√≥ximo da espera (Sem apagar convidados)
        if(!isWait && listaEspera.length > 0) {
            const proximoMembroIdx = listaEspera.findIndex(p => jogadores.includes(p.nome) && !p.isGuest);
            const pIdx = proximoMembroIdx !== -1 ? proximoMembroIdx : 0;
            const proximo = listaEspera[pIdx];

            // Move para confirmados
            await remove(ref(db, `listaEspera/${proximo.id}`));
            await push(ref(db, 'confirmados'), { 
                nome: proximo.nome, 
                isGuest: proximo.isGuest || false, 
                guestOf: proximo.guestOf || null, 
                data: proximo.data 
            });
        }

        // 3. Notifica√ß√£o WhatsApp (Abre o chat com voc√™ avisando da sa√≠da)
        const telefoneOrganizador = "5541987210685";
        const msgTexto = `AVISO: O jogador ${nomeAlvo} acabou de cancelar a inscri√ß√£o na 1¬™ Etapa. Verifique a lista!`;
        const linkWA = `https://wa.me/${telefoneOrganizador}?text=${encodeURIComponent(msgTexto)}`;
        
        document.getElementById('modalCancelar').classList.remove('active');
        window.open(linkWA, '_blank');

    } catch (e) { alert("Erro ao processar cancelamento."); }
};

function atualizarUI() {
    document.getElementById('statusIndicator').textContent = '‚úÖ Conectado';
    confirmedCount.textContent = confirmados.length;
    vacancyCount.textContent = Math.max(0, LIMITE_VAGAS - confirmados.length);
    waitlistCount.textContent = listaEspera.length;

    const formatTime = (iso) => new Date(iso).toLocaleTimeString('pt-BR', {hour:'2-digit', minute:'2-digit'});

    // Lista Confirmados
    confirmedList.innerHTML = confirmados.map((p, i) => `
        <li class="player-item">
            <div class="player-info">
                <div class="player-number">${i+1}¬∫</div>
                <div class="player-details"><strong>${p.nome}</strong><small>üïí ${formatTime(p.data)}</small></div>
            </div>
            ${jogadores.includes(p.nome) ? '<span class="player-badge member">MEMBRO</span>' : ''}
        </li>`).join('') || '<li class="empty-state">Vazio</li>';

    // Lista Espera (Ordenada: Membros primeiro, depois por data)
    const filaOrdenada = [...listaEspera].sort((a, b) => {
        const aM = jogadores.includes(a.nome) && !a.isGuest;
        const bM = jogadores.includes(b.nome) && !b.isGuest;
        if (aM && !bM) return -1;
        if (!aM && bM) return 1;
        return new Date(a.data) - new Date(b.data);
    });

    waitlistList.innerHTML = filaOrdenada.map((p, i) => {
        const isM = jogadores.includes(p.nome) && !p.isGuest;
        const bClass = p.isGuest ? 'guest' : (isM ? 'member' : 'wait');
        return `
        <li class="player-item">
            <div class="player-info">
                <div class="player-number">${i+1}¬∫</div>
                <div class="player-details">
                    <strong>${p.nome}</strong><small>üïí ${formatTime(p.data)}</small>
                    ${p.guestOf ? `<small>üë§ Convidado de ${p.guestOf}</small>` : ''}
                </div>
            </div>
            <span class="player-badge ${bClass}">${p.isGuest ? 'CONVIDADO' : (isM ? 'MEMBRO' : 'ESPERA')}</span>
        </li>`}).join('') || '<li class="empty-state">Vazio</li>';
}

async function verificarQuartaFeira() {
    const agora = new Date();
    const dataEvento = new Date('2026-01-29');
    const quarta = new Date(dataEvento); quarta.setDate(dataEvento.getDate() - 1); quarta.setHours(10, 0, 0, 0);
    if (agora >= quarta && confirmados.length < LIMITE_VAGAS && listaEspera.length > 0) {
        const pMembro = listaEspera.find(p => jogadores.includes(p.nome) && !p.isGuest);
        if (pMembro) {
             await remove(ref(db, `listaEspera/${pMembro.id}`));
             await push(ref(db, 'confirmados'), { ...pMembro, id: null });
        }
    }
}

btnExportar.onclick = () => {
    let csv = "\uFEFFPosicao,Nome,Status\n";
    confirmados.forEach((p, i) => csv += `${i+1},${p.nome},Confirmado\n`);
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'poker_lista.csv';
    link.click();
};
</script>
</body>
</html>
